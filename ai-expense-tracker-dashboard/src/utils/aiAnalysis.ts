// src/utils/aiAnalysis.ts

export async function analyzeExpenses(expenses: any[]): Promise<string> {
  if (!expenses || expenses.length === 0) {
    return "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞. –ó–∞–≥—Ä—É–∑–∏—Ç–µ CSV —Å —Ä–∞—Å—Ö–æ–¥–∞–º–∏.";
  }

  // –ë–µ—Ä—ë–º –Ω–µ –±–æ–ª—å—à–µ 50 –∑–∞–ø–∏—Å–µ–π, —á—Ç–æ–±—ã –Ω–µ —Ä–∞–∑–¥—É–ª—Å—è –∑–∞–ø—Ä–æ—Å
  const trimmed = expenses.slice(0, 50).map((e) => ({
    name: e.name ?? e.title ?? "–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è",
    amount: Number(e.amount) || 0,
    date: e.date ?? "",
  }));

  const total = trimmed.reduce((s, e) => s + e.amount, 0);

  const systemPrompt = `
–¢—ã —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –∏ –ø–æ–º–æ–≥–∞–µ—à—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –Ω–∞ –ø–æ–Ω—è—Ç–Ω–æ–º —á–µ–ª–æ–≤–µ—á–µ—Å–∫–æ–º —è–∑—ã–∫–µ.
–¢–µ–±–µ –¥–∞—é—Ç —Å–ø–∏—Å–æ–∫ —Ä–∞—Å—Ö–æ–¥–æ–≤ (name, amount, date) –≤ JSON.
–¢–≤–æ—è –∑–∞–¥–∞—á–∞:
1) –ö—Ä–∞—Ç–∫–æ –æ–ø–∏—Å–∞—Ç—å –∫–∞—Ä—Ç–∏–Ω—É —Ä–∞—Å—Ö–æ–¥–æ–≤.
2) –ù–∞–∑–≤–∞—Ç—å 2‚Äì3 –≥–ª–∞–≤–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏/—Ç–∏–ø–∞ —Ç—Ä–∞—Ç (–¥–∞–∂–µ –µ—Å–ª–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –Ω–µ—Ç, –ø–æ–ø—ã—Ç–∞–π—Å—è –¥–æ–≥–∞–¥–∞—Ç—å—Å—è).
3) –£–∫–∞–∑–∞—Ç—å, –≥–¥–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ç—Ä–∞—Ç–∏—Ç —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ.
4) –î–∞—Ç—å 3‚Äì5 –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –ø–æ —ç–∫–æ–Ω–æ–º–∏–∏.
5) –ü–∏—Å–∞—Ç—å –ø–æ-—Ä—É—Å—Å–∫–∏, –∫—Ä–∞—Ç–∫–æ –∏ –ø–æ –¥–µ–ª—É.
–ù–µ –ø–∏—à–∏ JSON, —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç.
`;

  const userPrompt = `
–í–æ—Ç –º–æ–∏ —Ä–∞—Å—Ö–æ–¥—ã –≤ JSON (–º–∞–∫—Å–∏–º—É–º 50 —Å—Ç—Ä–æ–∫):

${JSON.stringify(trimmed, null, 2)}

–û–±—â–∞—è —Å—É–º–º–∞ (–ø–æ —Ç–≤–æ–∏–º –¥–∞–Ω–Ω—ã–º): ${total}.
–°–¥–µ–ª–∞–π –∞–Ω–∞–ª–∏–∑ –ø–æ —à–∞–≥–∞–º –∏ –¥–∞–π —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏.
`;

  const apiKey = import.meta.env.VITE_OPENAI_API_KEY;
  const model = import.meta.env.VITE_OPENAI_MODEL || "gpt-4o-mini";

  // üîÅ –ï—Å–ª–∏ API –∫–ª—é—á–∞ –Ω–µ—Ç ‚Äî –ø—Ä–æ—Å—Ç–æ–π –ª–æ–∫–∞–ª—å–Ω—ã–π ‚Äú–∞–Ω–∞–ª–∏–∑‚Äù
  if (!apiKey) {
    return `
(–õ–æ–∫–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –±–µ–∑ –≤–Ω–µ—à–Ω–µ–≥–æ –ò–ò)

–í—Å–µ–≥–æ —Ä–∞—Å—Ö–æ–¥–æ–≤: $${total}.
–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π: ${trimmed.length}.

–ü—Ä–∏–º–µ—Ä —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π:
- –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–≥—Ä–∞–Ω–∏—á–∏—Ç—å –∏–º–ø—É–ª—å—Å–∏–≤–Ω—ã–µ –ø–æ–∫—É–ø–∫–∏.
- –í–≤–µ–¥–∏—Ç–µ –ª–∏–º–∏—Ç—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º (–µ–¥–∞, —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç, —Ä–∞–∑–≤–ª–µ—á–µ–Ω–∏—è).
- –†–∞–∑ –≤ –Ω–µ–¥–µ–ª—é –ø–µ—Ä–µ—Å–º–∞—Ç—Ä–∏–≤–∞–π—Ç–µ –∫—Ä—É–ø–Ω—ã–µ —Ç—Ä–∞—Ç—ã.
    `.trim();
  }

  try {
    const res = await fetch("https://api.openai.com/v1/chat/completions", {
      method: "POST",
      headers: {
        Authorization: `Bearer ${apiKey}`,
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        model,
        messages: [
          { role: "system", content: systemPrompt },
          { role: "user", content: userPrompt },
        ],
        temperature: 0.4,
      }),
    });

    if (!res.ok) {
      const text = await res.text();
      console.error("OpenAI error:", text);
      return "–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ AI. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ API –∫–ª—é—á –∏ –ª–∏–º–∏—Ç—ã.";
    }

    const data = await res.json();
    const content = data.choices?.[0]?.message?.content;

    return content || "AI –Ω–µ –≤–µ—Ä–Ω—É–ª –æ—Å–º—ã—Å–ª–µ–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç.";
  } catch (err) {
    console.error("AI request failed:", err);
    return "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≤—è–∑–∞—Ç—å—Å—è —Å AI. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –∏–ª–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ API.";
  }
}
